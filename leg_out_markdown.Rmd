---
title: "Legionnaires' Disease Outbreaks"
author: "Holly Kessler"
date: "August 10, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The coordinates of the Legionnairess Disease outbreaks will be used to gather weather data from surrounding stations. The averages of the data will be taken and outputted into a graph containing data from the last 10 years before the outbreak.

First I installed and downloaded the packages needed including rnoaa from github.

```{r, eval=FALSE}
library(devtools)
install_github("geanders/rnoaa")
```

```{r, message=FALSE}
library(devtools)
library(rnoaa)
library(riem)
library(countyweather)
library(dplyr)
library(plyr)
library(tidyr)
library(weathermetrics)
library(ggplot2)
library(lubridate)
```

I created a data frame including the locations of each outbreak. I found the coordinates at http://maps.cga.harvard.edu/gpf/ and crossed checked them with Google coordinates. The other data in this set are year of outbreak and the year 10 years before the outbreak, onset date, and 14 days before the onset date. 

```{r, echo=FALSE}
outbreak_loc <- data.frame("id" = c("portugal","pittsburgh","quebec",
                                  "stoke-on-trent","edinburgh","miyazaki","pas-de-calais",
                                  "pamplona","rapid city","sarpsborg",
                                  "barrow-in-furness","murcia","melbourne","bovenkarspel",
                                  "london","sydney","genesee1","genesee2","columbus", "bronx"),
                           "file_id" = c("portugal","pittsburgh","quebec",
                                         "stoke_on_trent","edinburgh","miyazaki","pas_de_calais",
                                         "pamplona","rapid_city","sarpsborg","barrow_in_furness",
                                         "murcia","melbourne","bovenkarspel","london","sydney",
                                         "genesee1","genesee2","columbus","bronx"),
                           "latitude" = c(38.96, 40.43, 46.85, 53.02, 55.94,
                                          31.89, 50.51, 42.81, 44.06, 59.28,
                                          54.10, 37.98,-37.86, 52.70, 51.52,
                                         -33.85, 43.09, 43.09, 39.98, 40.82),
                           "longitude" = c(-8.99, -79.98, -71.34, -2.15, -3.20,
                                           131.34, 2.37, -1.65, -103.22, 11.08, 
                                           -3.22, -1.12, 145.07, 5.24, -0.10,
                                           150.93, -83.63, -83.63, -82.99, -73.92),
                           "year_min" = c(2004, 2002, 2002, 2002, 2002, 1992, 
                                          1993, 1996, 1995, 1995, 1992, 1991, 
                                          1990, 1989, 1979, 2006, 2004, 2005,
                                          2003, 2005),
                           "date_min" = c("2004-01-01", "2002-01-01", "2002-01-01", "2002-01-01", "2002-01-01", "1992-01-01", 
                                          "1993-01-01", "1996-01-01", "1995-01-01", "1995-01-01", "1992-01-01", "1991-01-01", 
                                          "1990-01-01", "1989-01-01", "1979-01-01", "2006-01-01", "2004-01-01", "2005-01-01",
                                          "2003-01-01", "2005-01-01"),
                           "year_max" = c(2014, 2012, 2012, 2012, 2012, 2002,
                                          2003, 2006, 2005, 2005, 2002, 2001,
                                          2000, 1999, 1989, 2016, 2014, 2015,
                                          2013, 2015),
                           "date_max" = c("2014-12-31", "2012-12-31", "2012-12-31", "2012-12-31", "2012-12-31", "2002-12-31",
                                          "2003-12-31", "2006-12-31", "2005-12-31", "2005-12-31", "2002-12-31", 
                                          "2001-12-31", "2000-12-31", "1999-12-31", "1989-12-31", "2016-12-31", 
                                          "2014-12-31", "2015-12-31", "2013-12-31", "2015-12-31"),
                           "onset" = c("2004-10-14", "2012-08-26", "2012-07-18", "2012-07-02", "2012-05-01",
                                       "2002-07-18", "2003-11-28", "2006-06-01", "2005-05-26", "2005-05-12",
                                       "2002-07-30", "2001-06-26", "2000-04-17", "1999-02-25", "1989-01-01",
                                       "2016-04-25", "2014-06-06", "2015-05-04", "2013-07-09", "2015-07-12"),
                           stringsAsFactors = FALSE
                           )

outbreak_loc$date_min <- as.character(outbreak_loc$date_min)
outbreak_loc$date_max <- as.character(outbreak_loc$date_max)
outbreak_loc$onset <- ymd(outbreak_loc$onset)
for(i in 1:length(outbreak_loc$onset)) {
  a <- as.Date(outbreak_loc$onset[i])
  b <- a - 14
  outbreak_loc[i,10] <- paste(b)
}
outbreak_loc <- rename(outbreak_loc, replace = c("V10"="before_onset"))
# outbreak_loc
knitr::kable(outbreak_loc)
```

The next function will download information from all of the stations. It only needs to be downloaded once per session. It will take a couple minutes to download.

I created a loop to get a list of the stations within 30 km of the location.
```{r eval = FALSE}
station_data <- ghcnd_stations()[[1]]
df <- list()
for(i in 1:length(outbreak_loc$id))
  {
    df[[i]] <- (meteo_nearby_stations(lat_lon_df = outbreak_loc[i,],
                                    station_data = station_data,
                                    var = c("PRCP","TAVG","TMAX","TMIN",
                                            "AWND","MDPR"),
                                    year_min = outbreak_loc[i, "year_min"],
                                    year_max = outbreak_loc[i, "year_max"],
                                    radius = 30))
  }

names(df) <- outbreak_loc$id
stations <- df
saveRDS(stations, file = "stations.RData")
```

```{r}
stations <- readRDS("stations.RData")
stations
```


Not all the locations have stations nearby. Therefore, I will omit them from the weather data evaluation using the following code.

```{r}
has_stations <- sapply(stations, function(x) nrow(x[[1]]) > 0)
outbreak_loc_true <- outbreak_loc %>%  filter(has_stations)
outbreak_loc_true
```


Using the countyweather codes I can gather the data for each station in a loop. The code gathers the weather data for each stations and averages them. Then I saved all the data as rds. files because they take a long time to gather. The data is saved in a folder I created called "weather_files/"

```{r, eval=FALSE}
for(i in which(has_stations))
{
    meteo_df <- meteo_pull_monitors(monitors = stations[[i]]$id,
                                 keep_flags = FALSE,
                                 date_min = outbreak_loc$date_min[i],
                                 date_max = outbreak_loc$date_max[i],
                                 var = c("prcp","snow","snwd","tmax","tmin","tavg"))

   coverage_df <- rnoaa::meteo_coverage(meteo_df, verbose = FALSE)
   filtered <- countyweather:::filter_coverage(coverage_df, 0.90)
   good_monitors <- unique(filtered$id)
   filtered_data <- dplyr::filter(meteo_df, id %in% good_monitors)
   averaged <- countyweather:::ave_weather(filtered_data)
   file_name <- paste0("weather_files/", outbreak_loc$file_id[i], ".rds")
   saveRDS(averaged, file_name)
   #readRDS(file_name)
  }
```

Now that all of the data is gathered and averaged I can plot the data. The loop will go through the files in order which is in alphabetical order. Therefore I must order my outbreak data frame into alphabetical order too. I will rename this data frame as df_stations for plotting. 

```{r, echo=FALSE}
df_stations <- arrange(outbreak_loc_true, id)
df_stations
```

# PLOT 1
## Outbreak Distribution

This plot is divided by outbreaks in the northern and southern hemisphere. This allows us to see when the outbreaks generally occur in the year. 

```{r, echo=FALSE}
df_stations$yday <- yday(df_stations$onset)
df_stations$hemisphere <- c("N","N","N","N","N","N","S","N","N","N","N","N","N","N","S")
ggplot(df_stations, aes(yday)) + geom_histogram(binwidth = 1) + 
  xlim(c(0,366)) + facet_grid(. ~ hemisphere)
```


# PLOT 2
## 10 years for all data

These plots allow for a quick glance into all the weather variables for each location. 

```{r, echo=FALSE }
for(file in list.files("weather_files"))
  {
  city_name <- gsub(".rds", "", file)
  averaged <- readRDS(paste0("weather_files/", file))
  
  ex <- averaged %>%
    select(-ends_with("reporting")) %>%
    gather("metric", "value", -date)
  
  a <- ggplot(ex, aes(x = date, y = value)) + geom_line() +
    facet_wrap(~ metric, ncol = 2, scales = "free_y") + 
    ggtitle(city_name)
  print(a)
}

```


# PLOT 3
## TMAX and TMIN

```{r, echo=FALSE}
for(file in list.files("weather_files"))
  {
  city_name <- gsub(".rds", "", file)
  averaged <- readRDS(paste0("weather_files/", file))
  
  ex <- averaged %>%
    select(-ends_with("reporting")) %>%
    gather("metric", "value", -date)

  to_plot <- filter(ex, metric %in% c("tmax", "tmin"))
  b <- ggplot(to_plot, aes(x = date, y = value, color = metric)) + 
    geom_line() + ggtitle(city_name)
  print(b)
  
  }

```


# PLOT 4
## Precipitation 

I also made a loop to plot graphs and histograms of the data with lines indicating each day before the start of the outbreak for a total of 14 days.A plot of the percentiles is also included.

```{r, echo=FALSE}

for(i in 1:length(list.files("weather_files")))
{
  file <- list.files("weather_files")[i]
  city_name <- gsub(".rds", "", file)
  averaged <- readRDS(paste0("weather_files/", file))
  
  ex <- averaged %>%
    select(-ends_with("reporting")) %>%
    gather("metric", "value", -date)
  
  to_plot <- filter(ex, metric=="prcp")
  a <- ggplot(to_plot, aes(x = date, y = value)) + ylab("PRCP (mm)") +
    geom_line() + ggtitle(city_name)
  print(a)
  
}

```


```{r, echo=FALSE, eval = FALSE}
for(i in 1:length(list.files("weather_files")))
{
  file <- list.files("weather_files")[i]
  city_name <- gsub(".rds", "", file)
  averaged <- readRDS(paste0("weather_files/", file))
  
  ex <- averaged %>%
    select(-ends_with("reporting")) %>%
    gather("metric", "value", -date)
  
  to_plot <- filter(ex, metric=="prcp")
  # a <- ggplot(to_plot, aes(x = date, y = value)) + ylab("PRCP (mm)") +
  #   geom_line() + ggtitle(city_name)
  # print(a)
  
    c_plot <- filter(ex, metric=="prcp")
    int <- interval(ymd(outbreak_loc[outbreak_loc$id == city_name,
                                    "before_onset"]),
                    ymd(outbreak_loc[outbreak_loc$id == city_name,
                                    "onset"]))
    c_outbreak <- filter(c_plot, date %within% int) #%>%
    c_outbreak <- mutate(c_outbreak, day_in_seq = 1:nrow(c_outbreak))
    c <- ggplot(c_plot, aes(value)) + geom_histogram(binwidth = 2) +
         geom_vline(data = c_outbreak,
                  aes(xintercept = value, color = day_in_seq),
                  alpha = 0.25) +
         ggtitle(city_name) + xlab("PRCP (mm)") +
         scale_color_gradientn(colors=rainbow(4))

    print(c)
}
```


```{r, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
for(i in 1:length(list(1:16)
{
  file <- list.files("weather_files")[i]
  city_name <- gsub(".rds", "", file)
  averaged <- readRDS(paste0("weather_files/", file))
  
  ex <- averaged %>%
    select(-ends_with("reporting")) %>%
    gather("metric", "value", -date)
  
  to_plot <- filter(ex, metric=="prcp")
  a <- ggplot(to_plot, aes(x = date, y = value)) + ylab("PRCP (mm)") +
    geom_line() + ggtitle(city_name)
  print(a)
  
    c_plot <- filter(ex, metric=="prcp")
    int <- interval(ymd(df_stations$before_onset[i]), ymd(df_stations$onset[i]))
    c_outbreak <- filter(c_plot, date %within% int) #%>%
    c_outbreak <- mutate(c_outbreak, day_in_seq = 1:nrow(c_outbreak))
    c <- ggplot(c_plot, aes(value)) + geom_histogram(binwidth = 2) +
         geom_vline(data = c_outbreak, 
                  aes(xintercept = value, color = day_in_seq), 
                  alpha = 0.25) + 
         ggtitle(city_name) + xlab("PRCP (mm)") +
         scale_color_gradientn(colors=rainbow(4))
             
    print(c)
}
```



# PLOT 5
## TMAX

```{r, echo=FALSE, eval=FALSE}
for(i in 1:length(list.files("weather_files")))
{
  file <- list.files("weather_files")[i]
  city_name <- gsub(".rds", "", file)
  averaged <- readRDS(paste0("weather_files/", file))
  
  ex <- averaged %>%
    select(-ends_with("reporting")) %>%
    gather("metric", "value", -date)
  
  to_plot <- filter(ex, metric=="tmax")
  to_plot$value <- to_plot$value
  a <- ggplot(to_plot, aes(x = date, y = value)) + ylab("TMAX (C)") +
    geom_line() + ggtitle(city_name)
  print(a)
  
  c_plot <- filter(ex, metric=="tmax")
  c_plot$value <- c_plot$value
  int <- interval(ymd(df_stations$before_onset[i]), ymd(df_stations$onset[i]))
  c_outbreak <- filter(c_plot, date %within% int) #%>%
  c_outbreak <- mutate(c_outbreak, day_in_seq = 1:nrow(c_outbreak))
  c <- ggplot(c_plot, aes(value)) + geom_histogram(binwidth = 2) +
    geom_vline(data = c_outbreak, 
               aes(xintercept = value, color = day_in_seq), 
               alpha = 0.25) + 
    ggtitle(city_name) + xlab("TMAX (C)") +
    scale_color_gradientn(colors=rainbow(4))
  
  print(c)
  
  #percentiles
  city_percentile <- ecdf(ex$value)(c_outbreak$value)
  c_outbreak$percentile <- city_percentile * 100
  
  d <- ggplot(c_outbreak, aes(x = day_in_seq, y = percentile)) +
    geom_bar(stat="identity") +
    ggtitle(city_name) +
    ylim(c(0,100))
  print(d)
}  
```


# PLOT 6
## TMIN

```{r, echo=FALSE, eval=FALSE}
for(i in 1:length(list.files("weather_files")))
{
  file <- list.files("weather_files")[i]
  city_name <- gsub(".rds", "", file)
  averaged <- readRDS(paste0("weather_files/", file))
  
  ex <- averaged %>%
    select(-ends_with("reporting")) %>%
    gather("metric", "value", -date)
  
  to_plot <- filter(ex, metric=="tmin")
  to_plot$value <- to_plot$value
  a <- ggplot(to_plot, aes(x = date, y = value)) + ylab("TMIN (C)") +
    geom_line() + ggtitle(city_name)
  print(a)
  
  c_plot <- filter(ex, metric=="tmin")
  c_plot$value <- c_plot$value
  int <- interval(ymd(df_stations$before_onset[i]), ymd(df_stations$onset[i]))
  c_outbreak <- filter(c_plot, date %within% int) #%>%
  c_outbreak <- mutate(c_outbreak, day_in_seq = 1:nrow(c_outbreak))
  c <- ggplot(c_plot, aes(value)) + geom_histogram(binwidth = 2) +
    geom_vline(data = c_outbreak, 
               aes(xintercept = value, color = day_in_seq), 
               alpha = 0.25) + 
    ggtitle(city_name) + xlab("TMIN (C)") +
    scale_color_gradientn(colors=rainbow(4))
  
  print(c)
  
  #percentiles
  city_percentile <- ecdf(ex$value)(c_outbreak$value)
  c_outbreak$percentile <- city_percentile * 100
  
  d <- ggplot(c_outbreak, aes(x = day_in_seq, y = percentile)) +
    geom_bar(stat="identity") +
    ggtitle(city_name) +
    ylim(c(0,100))
  print(d)

}
```



